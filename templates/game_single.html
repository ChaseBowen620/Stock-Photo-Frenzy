{% extends "base.html" %}

{% block title %}Game - Stock Photo Frenzy{% endblock %}

{% block content %}
<div class="container">
    <header>
        <h1><a href="{{ url_for('index') }}" style="color: inherit; text-decoration: none;">Stock Photo Frenzy</a></h1>
        <p>Round <span id="round-number">1</span> of 5</p>
        <div class="phrase-display" id="phrase-display" style="display: none;">
            <p>Search phrase: <span id="current-phrase"></span></p>
        </div>
    </header>
    
    <main>
        <div class="game-stats">
            <div class="stat-banner score-banner">
                <span class="stat-label">Score:</span>
                <span id="score" class="stat-value">0</span>
            </div>
            <div class="stat-banner round-banner">
                <span class="stat-label">Round:</span>
                <span id="round" class="stat-value">1/5</span>
            </div>
            <div class="stat-banner timer-banner">
                <span class="stat-label">Time:</span>
                <span id="timer" class="stat-value timer-value">1:00</span>
            </div>
        </div>
        
        <div class="image-container">
            <div id="loadingSpinner" class="loading-spinner" style="display: none;">
                <div class="spinner"></div>
                <p>Loading your challenge image...</p>
            </div>
            
            <div id="imageDisplay" class="image-display" style="display: none;">
                <img id="randomImage" src="" alt="Random stock photo">
                <div class="image-info">
                    <h3 id="imageTitle">_ _ _ _ _ _ _ _ _ _ _</h3>
                    <div class="image-meta">
                        <span id="imageId">ID: </span>
                        <span id="imageContributor">Contributor: </span>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="guessingInterface" class="guessing-interface" style="display: none;">
            <div class="guess-input-container">
                <input type="text" id="guessInput" placeholder="Enter a word to guess..." maxlength="20">
                <button id="guessBtn" class="btn-guess">Guess</button>
                <button id="forfeitBtn" class="btn-forfeit">Forfeit</button>
            </div>
            <div class="guess-feedback">
                <p id="guessFeedback" class="feedback-text"></p>
            </div>
        </div>
    </main>
</div>

<script>
let currentRound = 0;
let totalScore = 0;
let currentImage = null;
let originalTitle = '';
let titleWords = [];
let easyModeHiddenWords = []; // Words to hide in easy mode
let revealedWords = new Set();
let guessedWords = new Set();
let timeLeft = 60;
let timerInterval = null;
let isForfeited = false;
let difficulty = 'hard'; // Get from sessionStorage or default to hard

async function startRound() {
    if (currentRound >= 5) {
        // Game finished
        stopTimer();
        // Pass score as URL parameter
        window.location.href = `/results?score=${totalScore}`;
        return;
    }
    
    currentRound++;
    document.getElementById('round-number').textContent = currentRound;
    document.getElementById('round').textContent = `${currentRound}/5`;
    
    // Reset round state
    revealedWords.clear();
    guessedWords.clear();
    isForfeited = false;
    timeLeft = 60;
    updateTimerDisplay();
    resetForfeitButton();
    document.getElementById('loadingSpinner').style.display = 'block';
    document.getElementById('imageDisplay').style.display = 'none';
    document.getElementById('guessingInterface').style.display = 'none';
    
    try {
        // Get phrase and difficulty from session storage
        const phrase = sessionStorage.getItem('single_player_phrase') || '';
        const difficulty = sessionStorage.getItem('single_player_difficulty') || 'hard';
        let imageUrl = `/api/get-image?difficulty=${difficulty}`;
        if (phrase) {
            imageUrl += `&query=${encodeURIComponent(phrase)}`;
            document.getElementById('phrase-display').style.display = 'block';
            document.getElementById('current-phrase').textContent = phrase;
        }
        
        const response = await fetch(imageUrl);
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        setupGame(data.image);
    } catch (error) {
        console.error('Error loading image:', error);
        alert('Failed to load image. Please try again.');
    } finally {
        document.getElementById('loadingSpinner').style.display = 'none';
    }
}

function setupGame(image) {
    currentImage = image;
    originalTitle = image.title;
    titleWords = image.title_words; // All guessable words (for validation)
    
    // For easy mode, store which words to hide
    if (image.easy_mode_hidden_words && image.easy_mode_hidden_words.length > 0) {
        easyModeHiddenWords = image.easy_mode_hidden_words;
    } else {
        easyModeHiddenWords = [];
    }
    
    // Display image
    document.getElementById('randomImage').src = image.url;
    document.getElementById('imageId').textContent = `ID: ${image.id}`;
    document.getElementById('imageContributor').textContent = `Contributor: ${image.contributor}`;
    
    displayHiddenTitle();
    
    document.getElementById('imageDisplay').style.display = 'block';
    document.getElementById('guessingInterface').style.display = 'block';
    
    // Reset and focus input field
    document.getElementById('guessInput').value = '';
    document.getElementById('guessInput').focus();
    
    // Start the timer
    startTimer();
}

function displayHiddenTitle() {
    const allWords = originalTitle.toLowerCase()
        .replace(/[^\w\s]/g, ' ')
        .split(/\s+/)
        .filter(word => word.length > 0);
    
    // In easy mode, only hide the easyModeHiddenWords
    const wordsToHide = easyModeHiddenWords.length > 0 ? easyModeHiddenWords : titleWords;
    
    const displayWords = allWords.map(word => {
        if (wordsToHide.includes(word)) {
            if (revealedWords.has(word)) {
                return word;
            } else {
                return '_'.repeat(word.length);
            }
        } else {
            return word;
        }
    });
    
    let displayTitle = originalTitle;
    allWords.forEach((word, index) => {
        const displayWord = displayWords[index];
        const wordRegex = new RegExp(`\\b${word}\\b`, 'gi');
        displayTitle = displayTitle.replace(wordRegex, displayWord);
    });
    
    document.getElementById('imageTitle').textContent = displayTitle;
}

function makeGuess() {
    if (isForfeited) return;
    
    const guess = document.getElementById('guessInput').value.trim().toLowerCase();
    
    if (!guess || guess.length < 3) {
        showFeedback('Word must be at least 3 characters long!', 'incorrect');
        return;
    }
    
    if (guessedWords.has(guess)) {
        showFeedback('You already guessed this word!', 'already-guessed');
        document.getElementById('guessInput').value = '';
        return;
    }
    
    guessedWords.add(guess);
    
    // Check if word is in titleWords (all guessable words)
    const foundWords = titleWords.filter(word => word === guess);
    
    if (foundWords.length > 0) {
        // In easy mode, only reveal if it's one of the hidden words
        const wordsToReveal = easyModeHiddenWords.length > 0 ? easyModeHiddenWords : titleWords;
        const relevantWords = foundWords.filter(word => wordsToReveal.includes(word));
        
        if (relevantWords.length > 0) {
            relevantWords.forEach(word => {
                revealedWords.add(word);
            });
            
            const points = relevantWords.length * 10;
            totalScore += points;
            updateScore();
            
            showFeedback(`Great! Found "${guess}" (${relevantWords.length} time${relevantWords.length > 1 ? 's' : ''})! +${points} points`, 'correct');
            
            displayHiddenTitle();
            
            // Check if all words revealed
            if (revealedWords.size === wordsToReveal.length) {
            stopTimer();
            totalScore += 100; // Completion bonus
            updateScore();
            showFeedback('Perfect! All words found! +100 completion bonus!', 'correct');
            
                // Move to next round after delay
                setTimeout(() => {
                    startRound();
                }, 3000);
            }
        } else {
            // Word is in title but not one of the words to reveal in easy mode
            showFeedback(`"${guess}" is in the title, but not one of the hidden words!`, 'incorrect');
        }
    } else {
        showFeedback(`"${guess}" is not in the title. Try again!`, 'incorrect');
    }
    
    // Always reset input field
    document.getElementById('guessInput').value = '';
}

function updateScore() {
    document.getElementById('score').textContent = totalScore;
}

function showFeedback(message, type) {
    const feedback = document.getElementById('guessFeedback');
    feedback.textContent = message;
    feedback.className = `feedback-text ${type}`;
}

function forfeitGame() {
    if (isForfeited) return;
    
    isForfeited = true;
    stopTimer();
    
    // Reveal all words
    const wordsToReveal = easyModeHiddenWords.length > 0 ? easyModeHiddenWords : titleWords;
    wordsToReveal.forEach(word => revealedWords.add(word));
    displayHiddenTitle();
    
    document.getElementById('forfeitBtn').disabled = true;
    showFeedback('Game forfeited! The title has been revealed.', 'incorrect');
    
    // Wait a few seconds before allowing next round
    setTimeout(() => {
        // Change forfeit button to "Next Round"
        document.getElementById('forfeitBtn').textContent = 'Next Round';
        document.getElementById('forfeitBtn').style.background = 'linear-gradient(45deg, #27ae60, #2ecc71)';
        document.getElementById('forfeitBtn').style.boxShadow = '0 4px 15px rgba(39, 174, 96, 0.4)';
        document.getElementById('forfeitBtn').disabled = false;
        document.getElementById('forfeitBtn').onclick = function() {
            startRound();
        };
    }, 3000); // 3 seconds delay
}

function startTimer() {
    stopTimer(); // Clear any existing timer
    timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        
        if (timeLeft <= 0) {
            forfeitGame();
        }
    }, 1000);
}

function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
}

function updateTimerDisplay() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    const timerElement = document.getElementById('timer');
    timerElement.textContent = timeString;
    
    timerElement.className = 'stat-value timer-value';
    if (timeLeft <= 10) {
        timerElement.classList.add('danger');
    } else if (timeLeft <= 30) {
        timerElement.classList.add('warning');
    }
}

function resetForfeitButton() {
    const forfeitBtn = document.getElementById('forfeitBtn');
    forfeitBtn.textContent = 'Forfeit';
    forfeitBtn.style.background = 'linear-gradient(45deg, #e74c3c, #c0392b)';
    forfeitBtn.style.boxShadow = '0 4px 15px rgba(231, 76, 60, 0.4)';
    forfeitBtn.disabled = false;
    forfeitBtn.onclick = forfeitGame;
}

// Get difficulty from sessionStorage
difficulty = sessionStorage.getItem('single_player_difficulty') || 'hard';

document.getElementById('guessBtn').addEventListener('click', makeGuess);
document.getElementById('forfeitBtn').addEventListener('click', forfeitGame);
document.getElementById('guessInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        makeGuess();
    }
});

// Start first round
startRound();
</script>
{% endblock %}

